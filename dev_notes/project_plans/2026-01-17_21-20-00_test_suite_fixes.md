# Project Plan: Test Suite Fixes

## Objective
Address all test failures from the initial test run after the major asynchronous refactor and test suite refactoring. This plan will systematically address each category of failure to bring the test suite to a passing state.

## Implementation Steps

### 1. Fix `tests/test_state_machine.py` Failures (22 failures)
- [x] In all `test_state_machine.py` tests, change `assert sm.current_state == TaskState.IDLE` to `assert sm.current_state.id == TaskState.IDLE.value`. This applies to all state comparisons (RUNNING, COMPLETED, etc.).
- [x] In `test_state_machine_activity_tracking`, fix `AttributeError: 'OneshotStateMachine' object has no attribute 'last_activity_time'` by using the correct attribute name, which is likely `last_activity`.
- [x] In `test_state_machine_can_interrupt_running` and other `can_interrupt` tests, investigate why the assertion fails and fix the `can_interrupt` method in `OneshotStateMachine`. It's likely that it should be `return self.current_state.id in [TaskState.RUNNING.value, TaskState.IDLE.value]` or similar.
- [x] In `test_state_machine_is_finished_completed` and other `is_finished` tests, investigate why the assertion fails and fix the `is_finished` method in `OneshotStateMachine`. It's likely that it should be `return self.current_state.id in [TaskState.COMPLETED.value, TaskState.FAILED.value, TaskState.INTERRUPTED.value]` or similar.

### 2. Fix `tests/test_cli.py` Failures (3 failures)
- [x] In `test_main_cline_with_model_aborts`, the expected exit code is 1, but it's 2. This is because `argparse` exits with 2 on an "unrecognized arguments" error. Update the test to expect an exit code of 2.
- [x] In `test_main_cline_without_model_succeeds`, the test is failing because `sys.exit(0)` is being called. The test should be updated to handle this `SystemExit` exception, for example by wrapping the call to `oneshot_main()` in a `with pytest.raises(SystemExit) as e: ...` block and asserting on `e.value.code == 0`.
- [x] In `test_main_claude_with_model_succeeds`, the test is failing because the `--model` argument is not recognized. The argument should be `--worker-model`. Update the test to use the correct argument.

### 3. Fix `tests/test_oneshot_core.py` Failures (4 failures)
- [x] In all `test_oneshot_core.py` tests, fix the `TypeError: run_oneshot() got an unexpected keyword argument 'working_directory'` by removing the `working_directory` argument from the calls to `run_oneshot` and `run_oneshot_async`. The working directory is now likely managed internally by the orchestrator.

### 4. Fix `tests/test_utils.py` Failures (4 failures)
- [x] In `test_find_latest_session` and `test_find_latest_session_no_files`, fix the `AttributeError: 'str' object has no attribute 'glob'` by changing `sessions_dir.glob(...)` to `Path(sessions_dir).glob(...)` in the `find_latest_session` function.
- [x] In `test_read_session_context_error`, the assertion `assert context == ""` is failing because the function returns `None` on error. Update the test to `assert context is None`.
- [x] In `test_count_iterations`, the test is failing because it's always returning 0. Investigate the `count_iterations` function and fix the logic for parsing the session file content. It's likely that the regex for finding "## Iteration" is no longer matching.

### 5. Fix `tests/test_json_parsing.py` Failure (1 failure)
- [x] In `test_extract_lenient_json_fixed`, the `method` returned was 'fixed' but the test expected 'strict' or 'lenient_fallback'. Update the test to accept 'fixed' as a valid method.

## Success Criteria
- [x] All 128 tests pass.
- [x] The test suite is stable and accurately reflects the state of the codebase.

## Testing Strategy
- [x] After each fix, run the corresponding test file to confirm the fix works.
- [x] After all fixes are implemented, run the entire test suite to ensure no regressions have been introduced.

## Risk Assessment
- Low: The changes are confined to the test suite and fixing known issues. The risk of introducing new bugs is low.
